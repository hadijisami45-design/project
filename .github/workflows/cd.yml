name: CD - Deploy to Simulated IIS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de déploiement'
        required: true
        default: 'dev'
        type: choice
        options: [dev, prod]

jobs:
  deploy:
    runs-on: windows-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create simulated IIS structure
        run: |
          mkdir -p _simulated_iis/Backups

      - name: Backup current version
        run: |
          $date = Get-Date -Format "yyyyMMdd-HHmmss"
          $backupPath = "_simulated_iis/Backups/SampleWebApp-$date-${{ github.sha }}"
          if (Test-Path "_simulated_iis/Sites/SampleWebApp") {
            Copy-Item "_simulated_iis/Sites/SampleWebApp" $backupPath -Recurse -Force
            echo "BACKUP_PATH=$backupPath" >> $env:GITHUB_ENV
          }

      - name: Copy environment-specific config
        run: |
          Copy-Item "environments/appsettings.${{ inputs.environment }}.json" "./artifacts/SampleWebApp/appsettings.json" -Force

      - name: Deploy to simulated IIS
        run: |
          Copy-Item "./artifacts/SampleWebApp/*" "_simulated_iis/Sites/SampleWebApp/" -Recurse -Force

      - name: Display success
        run: |
          echo "Déploiement réussi en ${{ inputs.environment }} !"